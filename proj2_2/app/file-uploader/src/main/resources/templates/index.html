<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspi File Stress Tester</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 850px;
        }

        .config-card {
            background: var(--card);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        h2 { margin-top: 0; color: #1e293b; font-size: 1.25rem; }

        .file-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label { font-weight: 600; font-size: 0.85rem; color: #64748b; }

        input[type="file"] {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            background: #fff;
        }

        .modes {
            margin-bottom: 2rem;
            padding: 1.2rem;
            background: #f1f5f9;
            border-radius: 0.75rem;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .mode-option:hover { background: #e2e8f0; }
        .mode-option input { cursor: pointer; }

        .btn-run {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.1s, opacity 0.2s;
        }

        .btn-run:active { transform: scale(0.99); }
        .btn-run:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-card {
            background: var(--card);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th {
            background: #f8fafc;
            padding: 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 1px solid var(--border);
        }

        td { padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }

        .badge-pending { background: #e2e8f0; color: #475569; }
        .badge-uploading { background: #fef9c3; color: #854d0e; }
        .badge-ok { background: #dcfce7; color: #15803d; }
        .badge-error { background: #fee2e2; color: #b91c1c; }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            width: 120px;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="config-card">
        <h2>üöÄ –ó–∞–ª–ø–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
        
        <div class="file-inputs">
            <div class="input-group">
                <label>–§–∞–π–ª A (–û—Å–Ω–æ–≤–Ω–æ–π)</label>
                <input type="file" id="fileA">
            </div>
            <div class="input-group">
                <label>–§–∞–π–ª B (–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π)</label>
                <input type="file" id="fileB">
            </div>
        </div>

        <div class="modes">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #475569;">–†–µ–∂–∏–º –Ω–∞–≥—Ä—É–∑–∫–∏:</label>
            <label class="mode-option">
                <input type="radio" name="mode" value="2x2" checked>
                <span><b>–°–∏–º–º–µ—Ç—Ä–∏—è:</b> 2x File A + 2x File B (–†–∞–∑–æ–º)</span>
            </label>
            <label class="mode-option">
                <input type="radio" name="mode" value="4x2">
                <span><b>–ü–µ—Ä–µ–∫–æ—Å:</b> 4x File A + 2x File B (–†–∞–∑–æ–º)</span>
            </label>
        </div>

        <button id="runBtn" class="btn-run" onclick="startStressTest()">–ó–ê–ü–£–°–¢–ò–¢–¨ –¢–ï–°–¢</button>
    </div>

    <div class="status-card">
        <table>
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–§–∞–π–ª</th>
                    <th>–î—É–±–ª–∏–∫–∞—Ç</th>
                    <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                    <th>–°—Ç–∞—Ç—É—Å API</th>
                </tr>
            </thead>
            <tbody id="statusTable">
                </tbody>
        </table>
    </div>
</div>

<script>
    // URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–º–æ–∂–µ—à—å –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ —Å–≤–æ–π)
    const API_URL = '/'; 

    async function startStressTest() {
        const fileA = document.getElementById('fileA').files[0];
        const fileB = document.getElementById('fileB').files[0];
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const tableBody = document.getElementById('statusTable');
        const runBtn = document.getElementById('runBtn');

        if (!fileA || !fileB) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ —Ñ–∞–π–ª–∞ (A –∏ B)!');
            return;
        }

        // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
        tableBody.innerHTML = '';
        runBtn.disabled = true;

        const queue = [];
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∂–∏–º—É
        if (mode === '2x2') {
            queue.push({ file: fileA, name: fileA.name, label: 'A' }, { file: fileA, name: fileA.name, label: 'A' });
            queue.push({ file: fileB, name: fileB.name, label: 'B' }, { file: fileB, name: fileB.name, label: 'B' });
        } else {
            for(let i=0; i<4; i++) queue.push({ file: fileA, name: fileA.name, label: 'A' });
            for(let i=0; i<2; i++) queue.push({ file: fileB, name: fileB.name, label: 'B' });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        const promises = queue.map((task, index) => {
            return sendFileRequest(task, index + 1);
        });

        await Promise.allSettled(promises);
        runBtn.disabled = false;
        console.log('–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã');
    }

    function sendFileRequest(task, id) {
        return new Promise((resolve) => {
            const tableBody = document.getElementById('statusTable');
            const rowId = `row-${id}`;
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td>#${id}</td>
                <td><b>${task.name}</b> <small style="color:blue">[${task.label}]</small></td>
                <td>–ö–æ–ø–∏—è</td>
                <td>
                    <div class="progress-bar"><div id="bar-${id}" class="progress-fill"></div></div>
                </td>
                <td><span id="badge-${id}" class="badge badge-pending">WAITING</span></td>
            `;
            tableBody.appendChild(row);

            const formData = new FormData();
            formData.append('files', task.file); // 'files' - –∏–º—è –ø–æ–ª—è –∫–∞–∫ –≤ Java –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ

            const xhr = new XMLHttpRequest();
            const badge = document.getElementById(`badge-${id}`);
            const bar = document.getElementById(`bar-${id}`);

            xhr.open('POST', API_URL, true);

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    bar.style.width = percent + '%';
                    badge.innerText = 'UPLOADING...';
                    badge.className = 'badge badge-uploading';
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    badge.innerText = 'SUCCESS (200)';
                    badge.className = 'badge badge-ok';
                    bar.style.backgroundColor = 'var(--success)';
                } else {
                    badge.innerText = `ERR (${xhr.status})`;
                    badge.className = 'badge badge-error';
                }
                resolve();
            };

            xhr.onerror = () => {
                badge.innerText = 'CONN ERROR';
                badge.className = 'badge badge-error';
                resolve();
            };

            xhr.send(formData);
        });
    }
</script>

</body>
</html>